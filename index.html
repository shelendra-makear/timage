<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebXR Image Tracking</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    #enter-ar {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; font-size: 16px; border: none; border-radius: 10px;
      background: #007bff; color: white; cursor: pointer;
    }
  </style>
</head>

<body>
<button id="enter-ar">Enter AR</button>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.min.js"></script>

<script>
/* --------------------
   GLOBAL VARIABLES
----------------------*/
let xrSession, renderer, scene, camera;
let box;              // object to attach to the tracked image
let trackedImage;     // runtime-tracked image info
let xrRefSpace;       // reference space

/* --------------------
   INIT THREE.JS SCENE
----------------------*/
function createScene() {
  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
  scene.add(camera);

  // A simple 3D box that will appear on the tracked image
  const geo = new THREE.BoxGeometry(0.1, 0.1, 0.1);
  const mat = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
  box = new THREE.Mesh(geo, mat);
  box.visible = false;  // hidden until image detected
  scene.add(box);

  // Light
  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbbb, 1);
  scene.add(light);
}

/* --------------------
   START AR SESSION
----------------------*/
async function startAR() {
  if (!navigator.xr) {
    alert("WebXR not supported on this browser/device");
    return;
  }

  const imgBitmap = await createImageBitmap(await fetchImage("chocos.png"));

  xrSession = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["image-tracking", "local"],
    trackedImages: [{
      image: imgBitmap,
      widthInMeters: 0.15 // real-world width of your target
    }]
  });

  renderer.xr.setSession(xrSession);

  xrRefSpace = await xrSession.requestReferenceSpace("local");

  xrSession.requestAnimationFrame(onXRFrame);
}

/* --------------------
   FRAME LOOP
----------------------*/
function onXRFrame(time, frame) {
  const session = frame.session;
  session.requestAnimationFrame(onXRFrame);

  const results = frame.getImageTrackingResults();

  for (const result of results) {
    const state = result.trackingState; // "tracked" | "emulated" | "not-tracked"
    const imageIndex = result.index;    // 0 if your single target

    if (state === "tracked") {
      trackedImage = result;

      const pose = frame.getPose(result.imageSpace, xrRefSpace);

      // attach a Three.js object to the pose
      if (pose) {
        const mat = new THREE.Matrix4().fromArray(pose.transform.matrix);
        box.visible = true;
        box.matrixAutoUpdate = false;
        box.matrix.copy(mat);
      }
    } else {
      box.visible = false;
    }
  }

  renderer.render(scene, camera);
}

/* --------------------
   UTILS
----------------------*/
async function fetchImage(url) {
  const res = await fetch(url);
  return await res.blob();
}

/* --------------------
   BUTTON EVENT
----------------------*/
document.getElementById("enter-ar").addEventListener("click", async () => {
  createScene();
  await startAR();
});
</script>

</body>
</html>
