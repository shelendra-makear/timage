<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebXR Image Target Demo</title>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; }
    #enter-ar {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 20px; font-size: 16px; border: none; border-radius: 10px;
      background: #007bff; color: white; cursor: pointer; z-index: 10;
    }
  </style>
</head>
<body>
<button id="enter-ar">Enter AR</button>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.164.0/examples/jsm/loaders/GLTFLoader.js';

let xrSession, renderer, scene, camera;
let model;
let xrRefSpace;

// -------------------- CREATE SCENE --------------------
function createScene() {
  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
  scene.add(camera);

  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbbb, 1);
  scene.add(light);
}

// -------------------- LOAD GLB MODEL --------------------
async function loadModel(url) {
  const loader = new GLTFLoader();
  return new Promise((resolve, reject) => {
    loader.load(url, gltf => resolve(gltf.scene), reject);
  });
}

// -------------------- FETCH IMAGE --------------------
async function fetchImage(url) {
  const res = await fetch(url);
  return res.blob();
}

// -------------------- START AR --------------------
async function startAR() {
  if (!navigator.xr) {
    alert("WebXR not supported on this browser.");
    return;
  }

  const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
  if (!isSupported) {
    alert("AR not supported on this device.");
    return;
  }

  const imgBitmap = await createImageBitmap(await fetchImage('marker-image.png'));

  try {
    xrSession = await navigator.xr.requestSession('immersive-ar', {
      requiredFeatures: ['local'],
      optionalFeatures: ['image-tracking'],
      trackedImages: [{ image: imgBitmap, widthInMeters: 0.15 }]
    });
  } catch (err) {
    console.error("Failed to start AR session:", err);
    alert("AR session could not start. Your browser may not support image tracking.");
    return;
  }

  renderer.xr.setSession(xrSession);
  xrRefSpace = await xrSession.requestReferenceSpace('local');

  xrSession.requestAnimationFrame(onXRFrame);
}

// -------------------- FRAME LOOP --------------------
function onXRFrame(time, frame) {
  const session = frame.session;
  session.requestAnimationFrame(onXRFrame);

  if (!model) return;

  const results = frame.getImageTrackingResults();

  for (const result of results) {
    const state = result.trackingState;

    if (state === 'tracked') {
      const pose = frame.getPose(result.imageSpace, xrRefSpace);
      if (pose) {
        model.matrixAutoUpdate = false;
        model.visible = true;
        model.matrix.fromArray(pose.transform.matrix);
      }
    } else {
      model.visible = false;
    }
  }

  renderer.render(scene, camera);
}

// -------------------- BUTTON CLICK --------------------
document.getElementById('enter-ar').addEventListener('click', async () => {
  createScene();

  model = await loadModel('anim1.glb'); // replace with your model
  model.scale.set(0.1, 0.1, 0.1);
  model.visible = false;
  scene.add(model);

  await startAR();
});
</script>
</body>
</html>
