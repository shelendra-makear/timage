
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <a-scene mindar-image="imageTargetSrc: /targets.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-assets>
	<a-asset-item id="anim1" src="./assets/anim1.glb"></a-asset-item>
    <a-asset-item id="anim2" src="./assets/anim2.glb"></a-asset-item>
    <a-asset-item id="anim3" src="./assets/anim3.glb"></a-asset-item>
  
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" name="shared-image">
        
    <a-entity
      id="model1"
      gltf-model="#anim1"
      visible="false"
      position="0 0 -0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="model2"
      gltf-model="#anim2"
      visible="false"
      position="0 -1 -1"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>

    <a-entity
      id="model3"
      gltf-model="#anim3"
      visible="false"
      position="0 0 0"
      scale="0.7 0.7 0.7"
      animation-mixer="clip: *; loop: once; clampWhenFinished: true"></a-entity>
   

    
      <a-entity animation-sequence="entities: #model1, #model2, #model3"></a-entity>

      </a-entity>
    </a-scene>
  </body>
  <script>// app.js
AFRAME.registerComponent('animation-sequence', {
  schema: {
    entities: {type: 'array'},   // array of CSS selectors
  },

  init() {
    // Cache entity references
    this.ents = this.data.entities.map(sel => document.querySelector(sel))
    this.currentIndex = 0
    this.sequenceStarted = false
    this.sequenceCompleted = false
    this._onAnimFinished = null

    const scene = this.el.sceneEl

    scene.addEventListener('loaded', () => {
      console.log('ğŸ¬ Scene fully loaded.')
      this.setupSequence()
    })
  },

  setupSequence() {
    console.log('âœ… Animation sequence ready.')

    // MindAR image target reference
    let imageTarget =
      document.querySelector('[mindar-image-target="targetIndex: 0"]') ||
      document.querySelector('[mindar-image-target]')

    if (!imageTarget) {
      console.warn("â— No <a-entity mindar-image-target> found in the DOM.")
      return
    }

    console.log("ğŸ”— MindAR target found. Attaching listeners.")

    const onFound = () => {
      console.log('ğŸŸ¢ Image found!')

      if (!this.sequenceStarted) {
        this.sequenceStarted = true
        this.chainAnimations()
      } else if (!this.sequenceCompleted) {
        this.resumeAll()
      }
    }

    const onLost = () => {
      console.log('â¸ï¸ Image lost.')
      if (!this.sequenceCompleted) this.pauseAll()
    }

    // Attach correct MindAR events
    imageTarget.addEventListener('targetFound', onFound)
    imageTarget.addEventListener('targetLost', onLost)
  },

  playEntity(index) {
    // Hide all others
    this.ents.forEach((e, i) => e.setAttribute('visible', i === index))

    const entity = this.ents[index]
    if (!entity) return

    const onModelLoaded = () => {
      const mixerComp = entity.components['animation-mixer']
      if (mixerComp && mixerComp.mixer) {
        const {mixer} = mixerComp

        mixer.stopAllAction()
        mixer.timeScale = 1

        const actions = Object.values(mixer._actions)
        if (actions.length > 0) {
          actions[0].reset().play()
          console.log(`ğŸ¥ Playing animation ${index + 1}`)
        } else {
          console.warn(`âš ï¸ No animation clips found in ${entity.id}`)
        }
      } else {
        console.warn(`âš ï¸ No animation-mixer on ${entity.id}`)
      }
    }

    // If loaded, act immediately â€” else wait
    if (entity.hasLoaded) onModelLoaded()
    else entity.addEventListener('model-loaded', onModelLoaded, {once: true})
  },

  pauseAll() {
    this.ents.forEach(e => {
      const m = e.components['animation-mixer']
      if (m?.mixer) m.mixer.timeScale = 0
    })
    console.log('â¸ï¸ Animations paused.')
  },

  resumeAll() {
    this.ents.forEach(e => {
      const m = e.components['animation-mixer']
      if (m?.mixer) m.mixer.timeScale = 1
    })
    console.log('â–¶ï¸ Animations resumed.')
  },

  chainAnimations() {
    if (this.sequenceCompleted) return

    const current = this.ents[this.currentIndex]
    const comp = current.components['animation-mixer']
    if (!comp?.mixer) {
      console.warn(`âš ï¸ No mixer found on entity ${current.id}`)
      return
    }

    const mixer = comp.mixer

    // Remove previous listeners
    if (this._onAnimFinished)
      mixer.removeEventListener('finished', this._onAnimFinished)

    // Create new handler
    this._onAnimFinished = () => {
      this.currentIndex++

      if (this.currentIndex < this.ents.length) {
        console.log(`â¡ï¸ Moving to animation ${this.currentIndex + 1}`)
        this.playEntity(this.currentIndex)
        this.chainAnimations()
      } else {
        this.sequenceCompleted = true
        console.log('ğŸ All animations finished successfully!')
      }
    }

    // Add MindAR-friendly event
    mixer.addEventListener('finished', this._onAnimFinished)

    // Start the current animation
    this.playEntity(this.currentIndex)
  },
})

window.addEventListener('load', () => {
  console.log('ğŸŒ app.js loaded and ready!')
})

</script>
</html>